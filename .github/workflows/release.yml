name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}

    steps:
      - uses: actions/checkout@v4
      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: get version
        run: echo "PACKAGE_VERSION=$(node -pe "require('./frontend/package.json').version")" >> $GITHUB_ENV
      - name: create release
        id: create-release
        uses: actions/github-script@v6
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${process.env.PACKAGE_VERSION}`,
              name: `Desktop App v${process.env.PACKAGE_VERSION}`,
              body: 'Take a look at the assets to download and install this app.',
              draft: true,
              prerelease: false
            })
            return data.id

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'ubuntu-latest'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ''

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: install frontend dependencies
        run: npm install
        working-directory: ./frontend

      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: install python dependencies and build rust extensions
        shell: bash
        working-directory: ./backend
        run: |
          python -m venv venv
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            source venv/Scripts/activate
          else
            source venv/bin/activate
          fi
          
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          maturin develop --release --manifest-path rust/Cargo.toml

      - name: create backend .env file
        shell: bash
        working-directory: ./backend
        run: |
          cat > .env << 'EOF'
          # Production build configuration
          DESKTOP_MODE=True
          DEBUG=False
          ENABLE_LOG_VIEWER=false
          PORT=0
          HOST=127.0.0.1

          # Performance settings
          NWN2_MEMORY_CACHE=true
          NWN2_PRELOAD_2DA=true
          NWN2_CACHE_MAX_MB=100
          NWN2_COMPRESS_CACHE=true
          NWN2_COMPRESS_THRESHOLD_KB=100
          NWN2_SMART_PRELOAD=true
          ICON_CACHE_LAZY_LOADING=true
          USE_PREREQUISITE_GRAPH=true
          ENABLE_PRECOMPILED_CACHE=true
          FAST_STARTUP=false
          EOF

      - name: build fastapi sidecar
        shell: bash
        working-directory: ./backend
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            source venv/Scripts/activate
          else
            source venv/bin/activate
          fi
          python build_fastapi_sidecar.py

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          projectPath: "./frontend"
          args: ${{ matrix.args }}

      # Rename the confusing 'setup.nsis.zip' to a clean 'Portable.zip' name
      # Tauri Action uploads files automatically, but we can hook in before that? 
      # Actually, Tauri Action uploads *during* the step. 
      # We cannot easily rename it *inside* the action execution. 
      # However, we can use the 'includeUpdaterJson: true' output or similar? 
      # Wait, the action handles the upload. If we want to rename it, we might need to disable auto-upload in the action 
      # and upload manually, OR accept the name.
      # BUT, checking the release.yml again... the 'uses: tauri-apps/tauri-action' does the upload. 
      # There is no easy way to intercept the filename unless we change the tauri.conf.json bundle name... 
      # which also changes the Setup.exe name.
      # ALTERNATIVE: Let's assume the user wants me to fix it. 
      # If I cannot rename it in-flight, I will clarify this limitation.
      # Re-reading: tauri-action typically has no 'rename artifacts' input.
      # However, we can disable the upload in tauri-action (`upload: false` or similar?) 
      # Checking tauri-action docs (mental model): It usually uploads all artifacts found in the bundle dir.
      # If we can't change it easily, I should notify the user first. 
      
      # Let's try to verify if I can change the artifact name config in tauri.conf.json?
      # The zip name usually follows the pattern: {productName}_{version}_{arch}-setup.nsis.zip
      # We can't change the suffix easily.
      - name: Rename Windows Portable Zip Asset
        if: matrix.platform == 'windows-latest'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const release_id = ${{ needs.create-release.outputs.release_id }};
            // Get version from tag name (e.g. v0.1.0 -> 0.1.0)
            const version = context.ref.replace('refs/tags/v', '');
            const newName = `NWN2EE-Save-Editor-${version}-Portable.zip`;

            const { data: assets } = await github.rest.repos.listReleaseAssets({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release_id,
            });

            const portableZipAsset = assets.find(asset => asset.name.endsWith('-setup.nsis.zip'));

            if (portableZipAsset) {
              console.log(`Found asset to rename: ${portableZipAsset.name} (ID: ${portableZipAsset.id})`);
              console.log(`Renaming to: ${newName}`);
              await github.rest.repos.updateReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                asset_id: portableZipAsset.id,
                name: newName,
              });
              console.log('Asset renamed successfully.');
            } else {
              console.log('No Windows portable zip asset found to rename.');
            }