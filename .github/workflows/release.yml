name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}
      upload_url: ${{ steps.create-release.outputs.upload_url }}

    steps:
      - uses: actions/checkout@v4
      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: get version
        run: echo "PACKAGE_VERSION=$(node -pe "require('./frontend/package.json').version")" >> $GITHUB_ENV
      - name: create release
        id: create-release
        uses: actions/github-script@v6
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${process.env.PACKAGE_VERSION}`,
              name: `Desktop App v${process.env.PACKAGE_VERSION}`,
              body: 'Take a look at the assets to download and install this app.',
              draft: true,
              prerelease: false
            })
            core.setOutput('upload_url', data.upload_url);
            return data.id

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'ubuntu-latest'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ''

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libfuse2 file

      - name: install frontend dependencies
        run: npm install
        working-directory: ./frontend

      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'


      - name: install python dependencies and build rust extensions
        shell: bash
        working-directory: ./backend
        run: |
          python -m venv venv
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            source venv/Scripts/activate
            echo "$PWD/venv/Scripts" >> $GITHUB_PATH
          else
            source venv/bin/activate
            echo "$PWD/venv/bin" >> $GITHUB_PATH
          fi

          python -m pip install --upgrade pip
          pip install -r requirements-production.txt
          pip install maturin nuitka

          maturin develop --release --manifest-path rust/Cargo.toml

      - name: create backend .env file
        shell: bash
        working-directory: ./backend
        run: |
          cat > .env << 'EOF'
          # Production build configuration
          DESKTOP_MODE=True
          DEBUG=False
          ENABLE_LOG_VIEWER=false
          PORT=0
          HOST=127.0.0.1

          # Performance settings
          NWN2_MEMORY_CACHE=true
          NWN2_PRELOAD_2DA=true
          NWN2_CACHE_MAX_MB=100
          NWN2_COMPRESS_CACHE=true
          NWN2_COMPRESS_THRESHOLD_KB=100
          NWN2_SMART_PRELOAD=true
          ICON_CACHE_LAZY_LOADING=true
          USE_PREREQUISITE_GRAPH=true
          ENABLE_PRECOMPILED_CACHE=true
          FAST_STARTUP=false
          EOF

      - name: build fastapi sidecar
        shell: bash
        working-directory: ./backend
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            source venv/Scripts/activate
          else
            source venv/bin/activate
          fi
          python build_fastapi_sidecar.py

      - name: Strip Debug Symbols (Linux)
        if: matrix.platform == 'ubuntu-latest'
        shell: bash
        run: |
          echo "Original size of sidecar distribution:"
          du -sh frontend/src-tauri/binaries/fastapi_server.dist || true
          
          echo "Stripping binaries..."
          find frontend/src-tauri/binaries/fastapi_server.dist -name "*.so*" -exec strip --strip-unneeded {} \; || true
          strip --strip-unneeded frontend/src-tauri/binaries/fastapi_server.dist/fastapi-server || true
          
          echo "Size after stripping:"
          du -sh frontend/src-tauri/binaries/fastapi_server.dist || true


      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          projectPath: "./frontend"
          args: ${{ matrix.args }}

      - name: Package Windows Portable
        if: matrix.platform == 'windows-latest'
        shell: bash
        run: |
          mkdir -p portable-staging/resources/binaries
          
          # Copy Main Executable
          cp "frontend/src-tauri/target/release/NWN2EE Save Editor.exe" "portable-staging/"
          
          # Copy Sidecar (FastAPI Dist)
          # Tauri resources are expected in 'resources/' relative to the binary
          cp -r "frontend/src-tauri/binaries/fastapi_server.dist" "portable-staging/resources/binaries/"
          
          # Zip it up
          7z a "frontend/src-tauri/target/release/bundle/nsis/NWN2EE-Save-Editor-Portable.zip" ./portable-staging/*
          
          echo "Portable zip created manually."

      - name: Upload Windows Portable Asset
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: frontend/src-tauri/target/release/bundle/nsis/NWN2EE-Save-Editor-Portable.zip
          asset_name: NWN2EE-Save-Editor-Portable.zip
          asset_content_type: application/zip